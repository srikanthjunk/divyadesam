<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peyarchi Analysis - BhaktiMap</title>

    <!-- Force HTTPS -->
    <script>
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            location.replace('https:' + window.location.href.substring(window.location.protocol.length));
        }
    </script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üïâÔ∏è</text></svg>">

    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 15px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: white;
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Hero Section */
        .hero {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
        }

        .hero h2 {
            color: #764ba2;
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .hero p {
            font-size: 1.1rem;
            color: #555;
            max-width: 800px;
            margin: 0 auto 20px;
        }

        /* Form Section */
        .form-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .form-section h3 {
            color: #764ba2;
            margin-bottom: 25px;
            font-size: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        label .required {
            color: #ef4444;
        }

        input, select {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .location-suggestions {
            position: absolute;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 1000;
            margin-top: 5px;
            display: none;
        }

        .location-suggestions.active {
            display: block;
        }

        .location-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }

        .location-item:hover {
            background: #f9fafb;
        }

        .alert-preferences {
            margin-top: 20px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 20px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading Spinner */
        .spinner {
            display: none;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f4f6;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .spinner.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .birth-chart {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .birth-chart h3 {
            color: #764ba2;
            margin-bottom: 20px;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .chart-item {
            padding: 20px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 10px;
            text-align: center;
        }

        .chart-item .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .chart-item .label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .chart-item .value {
            font-size: 1.3rem;
            font-weight: 600;
            color: #764ba2;
        }

        /* Peyarchi Status */
        .peyarchi-status {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .peyarchi-status h3 {
            color: #764ba2;
            margin-bottom: 20px;
        }

        .planet-card {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid;
        }

        .planet-card.favorable {
            border-color: #10b981;
            background: #ecfdf515;
        }

        .planet-card.neutral {
            border-color: #f59e0b;
            background: #fffbeb15;
        }

        .planet-card.unfavorable {
            border-color: #ef4444;
            background: #fef2f215;
        }

        .planet-card.critical {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .planet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .planet-name {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .effect-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .effect-badge.favorable {
            background: #10b981;
            color: white;
        }

        .effect-badge.neutral {
            background: #f59e0b;
            color: white;
        }

        .effect-badge.unfavorable {
            background: #ef4444;
            color: white;
        }

        .effect-badge.critical {
            background: #dc2626;
            color: white;
        }

        .planet-details {
            color: #555;
            line-height: 1.8;
        }

        .explanation {
            background: #f0f9ff;
            border-left: 4px solid #667eea;
            padding: 12px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: #444;
        }

        .temple-recommendation {
            background: #fef3c7;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .temple-recommendation h4 {
            margin-bottom: 10px;
            color: #92400e;
        }

        .temple-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .temple-options {
                grid-template-columns: 1fr;
            }
        }

        .temple-option {
            background: white;
            border-radius: 8px;
            padding: 12px;
        }

        .temple-option.shiva {
            border-left: 4px solid #f97316;
        }

        .temple-option.vishnu {
            border-left: 4px solid #3b82f6;
        }

        .temple-type {
            font-size: 12px;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
        }

        .temple-option.shiva .temple-type {
            color: #ea580c;
        }

        .temple-option.vishnu .temple-type {
            color: #2563eb;
        }

        .temple-option p {
            margin: 4px 0;
            font-size: 13px;
        }

        .pariharam-section {
            background: #f0fdf4;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .pariharam-section h4 {
            margin-bottom: 10px;
            color: #166534;
        }

        .pariharam-section p {
            margin: 8px 0;
            font-size: 14px;
        }

        .btn-small {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 13px;
            margin-top: 10px;
        }

        .btn-small:hover {
            background: #5a67d8;
        }

        /* Temple Recommendations */
        .temple-recommendations {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .temple-recommendations h3 {
            color: #764ba2;
            margin-bottom: 20px;
        }

        .temple-card {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .temple-info {
            flex: 1;
        }

        .temple-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .temple-deity {
            color: #6b7280;
            margin-bottom: 5px;
        }

        .temple-reason {
            color: #667eea;
            font-size: 0.9rem;
        }

        .temple-actions {
            display: flex;
            gap: 10px;
        }

        .btn-directions {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
        }

        .btn-directions:hover {
            background: #5568d3;
        }

        /* Map */
        #temple-map {
            height: 400px;
            border-radius: 10px;
            margin-top: 20px;
        }

        /* Error/Success Messages */
        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.active {
            display: block;
        }

        .message.error {
            background: #fef2f2;
            color: #dc2626;
            border-left: 4px solid #dc2626;
        }

        .message.success {
            background: #ecfdf5;
            color: #059669;
            border-left: 4px solid #10b981;
        }

        /* Footer */
        footer {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            text-align: center;
            padding: 30px 20px;
            border-radius: 15px;
            margin-top: 40px;
        }

        footer p {
            margin: 5px 0;
        }

        footer a {
            color: white;
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .hero {
                padding: 25px;
            }

            .hero h2 {
                font-size: 1.5rem;
            }

            .form-section {
                padding: 25px;
            }

            .planet-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .temple-card {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Signup Banner */
        .signup-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin-top: 25px;
            text-align: center;
            display: none;
        }

        .signup-banner.active {
            display: block;
        }

        .signup-banner h3 {
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .signup-banner p {
            margin-bottom: 20px;
            opacity: 0.95;
        }

        .signup-banner-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .signup-banner-buttons button {
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .btn-signup {
            background: white;
            color: #667eea;
            font-weight: 600;
        }

        .btn-signup:hover {
            background: #f0f0ff;
            transform: translateY(-2px);
        }

        .btn-guest {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.5) !important;
        }

        .btn-guest:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Signup Modal */
        .signup-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .signup-modal-overlay.active {
            display: flex;
        }

        .signup-modal {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }

        .signup-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }

        .signup-modal-close:hover {
            color: #333;
        }

        .signup-modal h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .password-wrapper {
            position: relative;
            display: block;
            width: 100%;
        }

        .password-wrapper input {
            width: 100%;
            padding-right: 45px;
        }

        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: #888;
            padding: 5px;
            line-height: 1;
        }

        .password-toggle:hover {
            color: #333;
        }

        .signup-modal p {
            color: #666;
            margin-bottom: 20px;
        }

        .signup-modal .form-group {
            text-align: left;
            margin-bottom: 15px;
        }

        .signup-modal label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .signup-modal input {
            width: 100%;
        }

        .signup-modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .signup-modal-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            border: none;
        }

        .signup-error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-content">
                <h1>üïâÔ∏è BhaktiMap - Peyarchi Analysis</h1>
                <a href="divya-desam-locator.html" class="back-button">
                    ‚Üê Back to Temples
                </a>
            </div>
        </header>

        <!-- Hero Section -->
        <div class="hero">
            <h2>üåü Discover Your Peyarchi Status</h2>
            <p>
                Get personalized planetary transit analysis based on your birth details.
                Receive email alerts for important peyarchi (Sani, Guru, Rahu, Ketu) and
                recommendations for Navagraha temple visits and pariharams.
            </p>
        </div>

        <!-- Messages -->
        <div id="errorMessage" class="message error"></div>
        <div id="successMessage" class="message success"></div>

        <!-- Form Section -->
        <div class="form-section">
            <h3>üìã Enter Your Birth Details</h3>

            <form id="peyarchiForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="email">Email <span class="required">*</span></label>
                        <input type="email" id="email" required placeholder="your@email.com">
                    </div>

                    <div class="form-group">
                        <label for="name">Name (Optional)</label>
                        <input type="text" id="name" placeholder="Your name">
                    </div>

                    <div class="form-group">
                        <label for="dateOfBirth">Date of Birth <span class="required">*</span></label>
                        <input type="date" id="dateOfBirth" required>
                    </div>

                    <div class="form-group">
                        <label for="timeOfBirth">Time of Birth <span class="required">*</span></label>
                        <input type="time" id="timeOfBirth" required>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1; position: relative;">
                        <label for="placeOfBirth">Place of Birth <span class="required">*</span></label>
                        <input type="text" id="placeOfBirth" required placeholder="Enter city name..." autocomplete="off">
                        <div id="locationSuggestions" class="location-suggestions"></div>
                    </div>
                </div>

                <div class="alert-preferences">
                    <h4>üìß Email Alert Preferences</h4>
                    <div class="checkbox-group">
                        <input type="checkbox" id="sendAlerts" checked>
                        <label for="sendAlerts">Send me peyarchi alerts and temple recommendations</label>
                    </div>
                    <div class="form-group">
                        <label for="alertFrequency">Alert Frequency</label>
                        <select id="alertFrequency">
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="major_only">Major Peyarchi Only</option>
                        </select>
                    </div>
                </div>

                <button type="submit" id="submitBtn">
                    Calculate My Peyarchi
                </button>
            </form>

            <div class="spinner" id="loadingSpinner"></div>
        </div>

        <!-- Results Section (Initially Hidden) -->
        <div id="resultsSection" class="results-section">
            <!-- Birth Chart -->
            <div class="birth-chart">
                <h3>‚ú® Your Birth Chart</h3>
                <div class="chart-grid" id="birthChartGrid">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <!-- Peyarchi Status -->
            <div class="peyarchi-status">
                <h3>üìä Current Peyarchi Status</h3>
                <div id="peyarchiCards">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <!-- Signup Banner (shown after results) -->
            <div id="signupBanner" class="signup-banner">
                <h3>üîî Get Peyarchi Alerts for Your Family</h3>
                <p>Create a free account to save your birth details, add family members, and receive email alerts when important planetary transits occur.</p>
                <div class="signup-banner-buttons">
                    <button class="btn-signup" onclick="showSignupModal()">Create Free Account</button>
                    <button class="btn-guest" onclick="dismissSignupBanner()">Continue as Guest</button>
                </div>
            </div>

        </div>

        <!-- Signup Modal -->
        <div id="signupModalOverlay" class="signup-modal-overlay" onclick="if(event.target === this) closeSignupModal()">
            <div class="signup-modal">
                <button class="signup-modal-close" onclick="closeSignupModal()">&times;</button>
                <h3>Create Your Account</h3>
                <p>Your birth details will be saved automatically. Add family members from your dashboard.</p>

                <div id="signupModalError" class="signup-error"></div>

                <div class="form-group">
                    <label>Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="signupPassword" placeholder="Min 6 characters" required onkeypress="if(event.key === 'Enter') handleQuickSignup()">
                        <button type="button" class="password-toggle" onclick="togglePassword()">üëÅ</button>
                    </div>
                </div>

                <div class="signup-modal-buttons">
                    <button style="background: #e0e0e0; color: #333;" onclick="closeSignupModal()">Cancel</button>
                    <button style="background: #667eea; color: white;" onclick="handleQuickSignup()">Create Account</button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p><strong>BhaktiMap</strong> - Plan Your Temple Pilgrimage with Ease</p>
            <p>In memory of Kokila & RP Sarathy</p>
            <p>
                <a href="divya-desam-locator.html">Temple Locator</a> |
                <a href="peyarchi.html">Peyarchi Analysis</a>
            </p>
        </footer>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Configuration
        const API_BASE_URL = 'https://api.bhaktimap.com/api';

        let selectedLocation = null;
        let locationTimeout = null;
        let map = null;

        // Form Elements
        const form = document.getElementById('peyarchiForm');
        const submitBtn = document.getElementById('submitBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultsSection = document.getElementById('resultsSection');
        const placeOfBirthInput = document.getElementById('placeOfBirth');
        const locationSuggestions = document.getElementById('locationSuggestions');

        // Message Elements
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');

        // Location Autocomplete
        placeOfBirthInput.addEventListener('input', async function() {
            const query = this.value.trim();

            if (query.length < 3) {
                locationSuggestions.classList.remove('active');
                return;
            }

            clearTimeout(locationTimeout);
            locationTimeout = setTimeout(async () => {
                await searchLocation(query);
            }, 500);
        });

        async function searchLocation(query) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}, India&limit=5`,
                    {
                        headers: {
                            'User-Agent': 'BhaktiMap/1.0'
                        }
                    }
                );

                const results = await response.json();
                displayLocationSuggestions(results);
            } catch (error) {
                console.error('Location search error:', error);
            }
        }

        function displayLocationSuggestions(results) {
            locationSuggestions.innerHTML = '';

            if (results.length === 0) {
                locationSuggestions.classList.remove('active');
                return;
            }

            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'location-item';
                item.textContent = result.display_name;
                item.onclick = () => selectLocation(result);
                locationSuggestions.appendChild(item);
            });

            locationSuggestions.classList.add('active');
        }

        function selectLocation(location) {
            selectedLocation = {
                name: location.display_name,
                latitude: parseFloat(location.lat),
                longitude: parseFloat(location.lon)
            };
            placeOfBirthInput.value = location.display_name;
            locationSuggestions.classList.remove('active');
        }

        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!placeOfBirthInput.contains(e.target)) {
                locationSuggestions.classList.remove('active');
            }
        });

        // Form Submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!selectedLocation) {
                showError('Please select a location from the suggestions');
                return;
            }

            const formData = {
                email: document.getElementById('email').value,
                name: document.getElementById('name').value,
                dateOfBirth: document.getElementById('dateOfBirth').value,
                timeOfBirth: document.getElementById('timeOfBirth').value,
                placeOfBirth: selectedLocation.name,
                latitude: selectedLocation.latitude,
                longitude: selectedLocation.longitude,
                timezone: 'Asia/Kolkata', // Default for India
                sendAlerts: document.getElementById('sendAlerts').checked,
                alertFrequency: document.getElementById('alertFrequency').value
            };

            // Save for signup
            lastFormData = formData;

            await submitPeyarchiForm(formData);
        });

        async function submitPeyarchiForm(data) {
            // Show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Calculating...';
            loadingSpinner.classList.add('active');
            hideMessages();

            try {
                const response = await fetch(`${API_BASE_URL}/subscribe`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    // Success
                    showSuccess('‚úÖ Success! Your peyarchi analysis is ready. Check your email for confirmation.');
                    displayResults(result);
                } else {
                    // Error
                    showError(result.error || 'Failed to calculate peyarchi. Please try again.');
                }
            } catch (error) {
                console.error('API Error:', error);
                showError('Unable to connect to server. Please try again later.');
            } finally {
                // Hide loading
                submitBtn.disabled = false;
                submitBtn.textContent = 'Calculate My Peyarchi';
                loadingSpinner.classList.remove('active');
            }
        }

        // Store form data for signup
        let lastFormData = null;

        function displayResults(data) {
            // Display Birth Chart
            displayBirthChart(data.birthChart);

            // Display Peyarchi Status
            displayPeyarchiStatus(data.currentPeyarchi);

            // Show results section
            resultsSection.classList.add('active');

            // Show signup banner (unless already logged in or dismissed)
            const hasToken = localStorage.getItem('bhaktimap_token');
            const isDismissed = sessionStorage.getItem('signup_dismissed');
            console.log('Signup banner check:', { hasToken: !!hasToken, isDismissed: !!isDismissed });

            if (!hasToken && !isDismissed) {
                console.log('Showing signup banner');
                document.getElementById('signupBanner').classList.add('active');
            } else {
                console.log('Not showing signup banner - already logged in or dismissed');
            }

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function displayBirthChart(birthChart) {
            const grid = document.getElementById('birthChartGrid');
            grid.innerHTML = `
                <div class="chart-item">
                    <div class="icon">üåü</div>
                    <div class="label">Nakshatra</div>
                    <div class="value">${birthChart.nakshatra || 'N/A'}</div>
                    <div class="label" style="font-size: 0.85rem;">Pada ${birthChart.nakshatra_pada || ''}</div>
                </div>
                <div class="chart-item">
                    <div class="icon">üåô</div>
                    <div class="label">Moon Sign (Rashi)</div>
                    <div class="value">${birthChart.rashi || 'N/A'}</div>
                </div>
                <div class="chart-item">
                    <div class="icon">‚¨ÜÔ∏è</div>
                    <div class="label">Ascendant (Lagna)</div>
                    <div class="value">${birthChart.lagna || 'N/A'}</div>
                </div>
            `;
        }

        function displayPeyarchiStatus(peyarchiData) {
            const container = document.getElementById('peyarchiCards');
            container.innerHTML = '';

            const planets = {
                'Sani': { icon: 'ü™ê', name: 'Shani', tamilName: '‡Æö‡Æ©‡Æø' },
                'Guru': { icon: 'üåü', name: 'Guru', tamilName: '‡Æï‡ØÅ‡Æ∞‡ØÅ' },
                'Rahu': { icon: 'üåë', name: 'Rahu', tamilName: '‡Æ∞‡Ææ‡Æï‡ØÅ' },
                'Ketu': { icon: '‚òÑÔ∏è', name: 'Ketu', tamilName: '‡Æï‡Øá‡Æ§‡ØÅ' }
            };

            for (const [planet, data] of Object.entries(peyarchiData)) {
                if (!planets[planet]) continue;

                const effectClass = data.effect.effect;
                const rashiDisplay = data.rashi_tamil || data.rashi;
                const card = document.createElement('div');
                card.className = `planet-card ${effectClass}`;

                // Build pariharam HTML if available
                let pariharamHtml = '';
                if (data.pariharam) {
                    pariharamHtml = `
                        <div class="pariharam-section">
                            <h4>üôè Pariharam (Remedies)</h4>
                            ${data.pariharam.rituals ? `<p><strong>Rituals:</strong> ${data.pariharam.rituals.join(', ')}</p>` : ''}
                            ${data.pariharam.mantras ? `<p><strong>Mantras:</strong> ${data.pariharam.mantras.join(', ')}</p>` : ''}
                            ${data.pariharam.donations ? `<p><strong>Donations:</strong> ${data.pariharam.donations.join(', ')}</p>` : ''}
                            ${data.pariharam.fasting ? `<p><strong>Fasting:</strong> ${data.pariharam.fasting}</p>` : ''}
                        </div>
                    `;
                }

                // Build temple HTML if available (both Shiva and Vishnu options)
                let templeHtml = '';
                if (data.temple) {
                    const shiva = data.temple.shiva;
                    const vishnu = data.temple.vishnu;

                    // Check if we have the new structure (with shiva/vishnu) or old structure
                    if (shiva && shiva.coordinates) {
                        templeHtml = `
                            <div class="temple-recommendation">
                                <h4>üèõÔ∏è Recommended Temples</h4>
                                <div class="temple-options">
                                    <div class="temple-option shiva">
                                        <span class="temple-type">üî± Shiva Navagraha</span>
                                        <p><strong>${shiva.name}</strong></p>
                                        <p>${shiva.location}</p>
                                        <a href="https://www.google.com/maps/dir/?api=1&destination=${shiva.coordinates.lat},${shiva.coordinates.lng}"
                                           target="_blank" class="btn-small">Directions ‚Üí</a>
                                    </div>
                                    ${vishnu && vishnu.coordinates ? `
                                    <div class="temple-option vishnu">
                                        <span class="temple-type">üôè Vishnu Navagraha</span>
                                        <p><strong>${vishnu.name}</strong></p>
                                        <p>${vishnu.location}</p>
                                        <a href="https://www.google.com/maps/dir/?api=1&destination=${vishnu.coordinates.lat},${vishnu.coordinates.lng}"
                                           target="_blank" class="btn-small">Directions ‚Üí</a>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    } else if (data.temple.coordinates) {
                        // Old structure fallback
                        templeHtml = `
                            <div class="temple-recommendation">
                                <h4>üèõÔ∏è Recommended Temple</h4>
                                <p><strong>${data.temple.name}</strong></p>
                                <p>${data.temple.location}</p>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${data.temple.coordinates.lat},${data.temple.coordinates.lng}"
                                   target="_blank" class="btn-small">Directions ‚Üí</a>
                            </div>
                        `;
                    }
                }

                card.innerHTML = `
                    <div class="planet-header">
                        <div class="planet-name">
                            ${planets[planet].icon} ${planet} (${planets[planet].tamilName})
                        </div>
                        <span class="effect-badge ${effectClass}">
                            ${effectClass}
                        </span>
                    </div>
                    <div class="planet-details">
                        <p><strong>Position:</strong> ${rashiDisplay} (${data.house_from_moon}th house from Moon)</p>
                        <p><strong>Period:</strong> ${data.start} to ${data.end}</p>
                        <p><strong>Effect:</strong> ${data.effect.desc}</p>
                        ${data.explanation ? `<div class="explanation"><strong>Analysis:</strong> ${data.explanation}</div>` : ''}
                        ${templeHtml}
                        ${pariharamHtml}
                    </div>
                `;
                container.appendChild(card);
            }
        }

        function displayTempleRecommendations(peyarchiData) {
            const container = document.getElementById('templeCards');
            container.innerHTML = '';

            const navagrahaTemples = {
                'Sani': { name: 'Thirunallar', deity: 'Sani (Saturn)', location: [10.8624, 79.3116] },
                'Guru': { name: 'Alangudi', deity: 'Guru (Jupiter)', location: [10.3667, 79.0167] },
                'Rahu': { name: 'Thirunageswaram', deity: 'Rahu', location: [10.7418, 79.2998] },
                'Ketu': { name: 'Keezhaperumpallam', deity: 'Ketu', location: [11.2334, 79.7644] }
            };

            const unfavorableTransits = [];
            for (const [planet, data] of Object.entries(peyarchiData)) {
                if (data.effect.effect === 'unfavorable' || data.effect.effect === 'critical') {
                    unfavorableTransits.push({ planet, ...data });
                }
            }

            if (unfavorableTransits.length === 0) {
                container.innerHTML = '<p style="color: #10b981;">‚úÖ No urgent temple visits needed. All transits are favorable!</p>';
                return;
            }

            // Display temple cards
            unfavorableTransits.forEach(transit => {
                const temple = navagrahaTemples[transit.planet];
                if (!temple) return;

                const card = document.createElement('div');
                card.className = 'temple-card';
                card.innerHTML = `
                    <div class="temple-info">
                        <div class="temple-name">üèõÔ∏è ${temple.name}</div>
                        <div class="temple-deity">${temple.deity}</div>
                        <div class="temple-reason">Remedy for ${transit.planet} ${transit.effect.effect}</div>
                    </div>
                    <div class="temple-actions">
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${temple.location[0]},${temple.location[1]}"
                           target="_blank"
                           class="btn-directions">
                            Get Directions ‚Üí
                        </a>
                    </div>
                `;
                container.appendChild(card);
            });

            // Initialize map if temples exist
            if (unfavorableTransits.length > 0) {
                initializeTempleMap(unfavorableTransits.map(t => navagrahaTemples[t.planet]));
            }
        }

        function initializeTempleMap(temples) {
            if (map) {
                map.remove();
            }

            // Center on Tamil Nadu
            map = L.map('temple-map').setView([11.0, 79.0], 8);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add markers for each temple
            temples.forEach(temple => {
                if (temple && temple.location) {
                    L.marker(temple.location)
                        .addTo(map)
                        .bindPopup(`<b>${temple.name}</b><br>${temple.deity}`);
                }
            });
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('active');
            successMessage.classList.remove('active');
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.add('active');
            errorMessage.classList.remove('active');
        }

        function hideMessages() {
            errorMessage.classList.remove('active');
            successMessage.classList.remove('active');
        }

        // ========================================
        // Signup Functions
        // ========================================
        function showSignupModal() {
            document.getElementById('signupModalOverlay').classList.add('active');
            document.getElementById('signupModalError').style.display = 'none';
        }

        function closeSignupModal() {
            document.getElementById('signupModalOverlay').classList.remove('active');
        }

        function dismissSignupBanner() {
            document.getElementById('signupBanner').classList.remove('active');
            sessionStorage.setItem('signup_dismissed', 'true');
        }

        function togglePassword() {
            const input = document.getElementById('signupPassword');
            const toggle = document.querySelector('.password-toggle');
            if (input.type === 'password') {
                input.type = 'text';
                toggle.textContent = 'üôà';
            } else {
                input.type = 'password';
                toggle.textContent = 'üëÅ';
            }
        }

        async function handleQuickSignup() {
            const password = document.getElementById('signupPassword').value;
            const errorDiv = document.getElementById('signupModalError');

            if (!password || password.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                errorDiv.style.display = 'block';
                return;
            }

            if (!lastFormData) {
                errorDiv.textContent = 'Please submit the peyarchi form first';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                // Create account
                const response = await fetch(`${API_BASE_URL}/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: lastFormData.email,
                        password: password,
                        name: lastFormData.name,
                        phone: ''
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Signup failed');
                }

                // Save token
                localStorage.setItem('bhaktimap_token', data.token);

                // Add self as family member with birth details
                console.log('Adding family member with:', lastFormData);
                const memberResponse = await fetch(`${API_BASE_URL}/family/members`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${data.token}`
                    },
                    body: JSON.stringify({
                        name: lastFormData.name,
                        relationship: 'self',
                        email: lastFormData.email,
                        dateOfBirth: lastFormData.dateOfBirth,
                        timeOfBirth: lastFormData.timeOfBirth,
                        placeOfBirth: lastFormData.placeOfBirth,
                        latitude: lastFormData.latitude,
                        longitude: lastFormData.longitude
                    })
                });

                const memberData = await memberResponse.json();
                console.log('Member response:', memberData);

                closeSignupModal();
                document.getElementById('signupBanner').classList.remove('active');

                // Replace banner with success message
                const banner = document.getElementById('signupBanner');

                if (!memberResponse.ok) {
                    console.error('Failed to add member:', memberData);
                    // Account created but member failed - show warning
                    showSuccess('Account created! Please add your birth details from the dashboard.');
                    banner.innerHTML = `
                        <h3>Account Created!</h3>
                        <p>Please add your birth details from the dashboard to receive peyarchi alerts.</p>
                        <div class="signup-banner-buttons">
                            <button class="btn-signup" onclick="window.location.href='dashboard.html'">Go to Dashboard</button>
                        </div>
                    `;
                } else {
                    // Full success - member added
                    showSuccess('Account created! Your birth details have been saved.');
                    banner.innerHTML = `
                        <h3>Account Created Successfully!</h3>
                        <p>Your birth details (${memberData.member.rashi} rashi) have been saved. You can add family members from your dashboard.</p>
                        <div class="signup-banner-buttons">
                            <button class="btn-signup" onclick="window.location.href='dashboard.html'">Go to Dashboard</button>
                        </div>
                    `;
                }
                banner.classList.add('active');

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        }
    </script>

    <!-- Version Footer -->
    <div id="version-footer" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); color: #fff; padding: 5px 12px; border-radius: 15px; font-size: 11px; z-index: 1000;">
        v1.5.5 | 22-NOV-2025
    </div>
</body>
</html>
