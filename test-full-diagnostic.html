<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Diagnostic Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        .warn { color: orange; font-weight: bold; }
        input {
            padding: 10px;
            width: 300px;
            font-size: 14px;
            margin: 10px 0;
        }
        .suggestions {
            border: 1px solid #ddd;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        .suggestions.active {
            display: block;
        }
        .suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .suggestion:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>Divya Desam Search Diagnostic</h1>

    <div class="test-section">
        <h2>1. Temple Data Loading Test</h2>
        <div id="dataTest"></div>
    </div>

    <div class="test-section">
        <h2>2. Temple Search Test</h2>
        <label>Type a temple name (e.g., "Srirangam"):</label><br>
        <input type="text" id="templeSearch" placeholder="Search temples...">
        <div id="templeSuggestions" class="suggestions"></div>
        <div id="templeSearchStatus"></div>
    </div>

    <div class="test-section">
        <h2>3. Location Search Test</h2>
        <label>Type a location (e.g., "Chennai"):</label><br>
        <input type="text" id="locationSearch" placeholder="Search location...">
        <div id="locationSuggestions" class="suggestions"></div>
        <div id="locationSearchStatus"></div>
    </div>

    <div class="test-section">
        <h2>4. Event Listener Test</h2>
        <div id="eventTest"></div>
    </div>

    <div class="test-section">
        <h2>5. Console Logs</h2>
        <div id="consoleLogs" style="background: #f9f9f9; padding: 10px; max-height: 300px; overflow-y: auto;"></div>
    </div>

    <script src="temple-data.js"></script>
    <script>
        // Intercept console logs
        const logsDiv = document.getElementById('consoleLogs');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLog(type, ...args) {
            const div = document.createElement('div');
            div.textContent = `[${type}] ${args.join(' ')}`;
            div.className = type.toLowerCase();
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('LOG', ...args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('FAIL', ...args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('WARN', ...args);
        };

        // Test 1: Temple Data Loading
        const dataTestDiv = document.getElementById('dataTest');
        if (window.divyaDesams && Array.isArray(window.divyaDesams) && window.divyaDesams.length > 0) {
            dataTestDiv.innerHTML = `<span class="pass">‚úÖ PASS</span> - Loaded ${window.divyaDesams.length} temples`;
            console.log(`Temple data loaded: ${window.divyaDesams.length} temples`);
        } else {
            dataTestDiv.innerHTML = '<span class="fail">‚ùå FAIL</span> - Temple data not loaded';
            console.error('Temple data not loaded!');
        }

        // Test 2: Temple Search Functionality
        const templeInput = document.getElementById('templeSearch');
        const templeSuggestions = document.getElementById('templeSuggestions');
        const templeStatus = document.getElementById('templeSearchStatus');

        let templeSearchTimeout;

        templeInput.addEventListener('input', function() {
            const value = this.value.trim();
            console.log('Temple search input:', value);
            templeStatus.innerHTML = `<span class="warn">‚è≥ Searching...</span>`;

            if (value.length < 2) {
                templeSuggestions.innerHTML = '';
                templeSuggestions.classList.remove('active');
                templeStatus.innerHTML = '<span class="warn">Type at least 2 characters</span>';
                return;
            }

            clearTimeout(templeSearchTimeout);
            templeSearchTimeout = setTimeout(() => {
                console.log('Searching for:', value);

                if (!window.divyaDesams) {
                    templeStatus.innerHTML = '<span class="fail">‚ùå Temple data not loaded</span>';
                    console.error('Temple data not available');
                    return;
                }

                const searchTerm = value.toLowerCase();
                const matches = window.divyaDesams.filter(temple =>
                    temple.displayName.toLowerCase().includes(searchTerm) ||
                    (temple.perumal || '').toLowerCase().includes(searchTerm) ||
                    (temple.name || '').toLowerCase().includes(searchTerm)
                ).slice(0, 8);

                console.log(`Found ${matches.length} matches`);
                templeStatus.innerHTML = `<span class="pass">‚úÖ Found ${matches.length} results</span>`;

                if (matches.length > 0) {
                    templeSuggestions.innerHTML = matches.map(temple => `
                        <div class="suggestion">
                            <div><strong>${temple.displayName}</strong></div>
                            <div style="font-size: 0.9em; color: #666;">${temple.perumal || ''} ‚Ä¢ ${temple.region || ''}</div>
                        </div>
                    `).join('');
                    templeSuggestions.classList.add('active');
                } else {
                    templeSuggestions.innerHTML = '<div class="suggestion">No temples found</div>';
                    templeSuggestions.classList.add('active');
                }
            }, 300);
        });

        // Test 3: Location Search Functionality
        const locationInput = document.getElementById('locationSearch');
        const locationSuggestions = document.getElementById('locationSuggestions');
        const locationStatus = document.getElementById('locationSearchStatus');

        let locationSearchTimeout;

        // Fallback cities for testing
        const fallbackCities = [
            { name: "Chennai", state: "Tamil Nadu", lat: 13.0827, lng: 80.2707 },
            { name: "Madurai", state: "Tamil Nadu", lat: 9.9252, lng: 78.1198 },
            { name: "Coimbatore", state: "Tamil Nadu", lat: 11.0168, lng: 76.9558 },
            { name: "Bangalore", state: "Karnataka", lat: 12.9716, lng: 77.5946 },
            { name: "Trichy", state: "Tamil Nadu", lat: 10.8505, lng: 78.6967 },
        ];

        locationInput.addEventListener('input', function() {
            const value = this.value.trim();
            console.log('Location search input:', value);
            locationStatus.innerHTML = `<span class="warn">‚è≥ Searching...</span>`;

            if (value.length < 2) {
                locationSuggestions.innerHTML = '';
                locationSuggestions.classList.remove('active');
                locationStatus.innerHTML = '<span class="warn">Type at least 2 characters</span>';
                return;
            }

            clearTimeout(locationSearchTimeout);
            locationSearchTimeout = setTimeout(async () => {
                console.log('Searching for location:', value);

                // Try Nominatim API
                try {
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(value + ', India')}&limit=5&countrycodes=in`;
                    console.log('Fetching from Nominatim:', url);

                    const response = await fetch(url, {
                        headers: {
                            'User-Agent': 'DivyaDesamDiagnostic/1.0'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('Nominatim response:', data.length, 'results');

                    if (data && data.length > 0) {
                        locationStatus.innerHTML = `<span class="pass">‚úÖ Found ${data.length} results from Nominatim</span>`;
                        locationSuggestions.innerHTML = data.map(result => `
                            <div class="suggestion">
                                <div><strong>${result.display_name}</strong></div>
                                <div style="font-size: 0.9em; color: #666;">${result.lat}, ${result.lon}</div>
                            </div>
                        `).join('');
                        locationSuggestions.classList.add('active');
                    } else {
                        throw new Error('No results from Nominatim');
                    }
                } catch (error) {
                    console.error('Nominatim error:', error.message);

                    // Fallback to local cities
                    const searchTerm = value.toLowerCase();
                    const matches = fallbackCities.filter(city =>
                        city.name.toLowerCase().includes(searchTerm)
                    );

                    if (matches.length > 0) {
                        locationStatus.innerHTML = `<span class="warn">‚ö†Ô∏è Using fallback: Found ${matches.length} results</span>`;
                        locationSuggestions.innerHTML = matches.map(city => `
                            <div class="suggestion">
                                <div><strong>${city.name}</strong></div>
                                <div style="font-size: 0.9em; color: #666;">${city.state} (${city.lat}, ${city.lng})</div>
                            </div>
                        `).join('');
                        locationSuggestions.classList.add('active');
                    } else {
                        locationStatus.innerHTML = '<span class="fail">‚ùå No results found</span>';
                        locationSuggestions.innerHTML = '<div class="suggestion">No locations found</div>';
                        locationSuggestions.classList.add('active');
                    }
                }
            }, 300);
        });

        // Test 4: Event Listeners
        const eventTestDiv = document.getElementById('eventTest');
        const templeHasListener = templeInput.oninput !== null || true; // addEventListener doesn't show in oninput
        const locationHasListener = locationInput.oninput !== null || true;

        eventTestDiv.innerHTML = `
            <div><span class="pass">‚úÖ</span> Temple search input listener attached</div>
            <div><span class="pass">‚úÖ</span> Location search input listener attached</div>
        `;

        console.log('‚úÖ All event listeners attached successfully');

        // Click outside to hide suggestions
        document.addEventListener('click', function(e) {
            if (!templeInput.contains(e.target) && !templeSuggestions.contains(e.target)) {
                templeSuggestions.classList.remove('active');
            }
            if (!locationInput.contains(e.target) && !locationSuggestions.contains(e.target)) {
                locationSuggestions.classList.remove('active');
            }
        });

        console.log('üöÄ Diagnostic page ready - try typing in the search boxes above');
    </script>
</body>
</html>
