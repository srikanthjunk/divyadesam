<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divya Desam Locator - Find Nearest Sacred Temples</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2rem;
            }
        }

        .left-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: fadeInUp 0.8s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        .map-container {
            background: white;
            border-radius: 20px;
            padding: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: fadeInUp 0.8s ease;
            height: 80vh;
            position: sticky;
            top: 20px;
        }

        #map {
            height: 100%;
            width: 100%;
            border-radius: 15px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn-locate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-locate:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
        }

        .autocomplete-container {
            position: relative;
            margin-bottom: 15px;
        }

        .route-input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .route-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .autocomplete-list.active {
            display: block;
        }

        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }

        .autocomplete-item .city-name {
            font-weight: 500;
            color: #333;
        }

        .autocomplete-item .city-state {
            font-size: 0.85rem;
            color: #666;
            margin-left: 10px;
        }

        .autocomplete-item .temple-type {
            color: #667eea;
            font-weight: 500;
        }

        .temple-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
            animation: slideIn 0.5s ease;
        }

        .temple-card:hover {
            transform: translateX(5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .temple-name {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .temple-distance {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 12px;
        }

        .temple-distance strong {
            color: #667eea;
            font-size: 1.1rem;
        }

        .btn-navigate {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 25px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .btn-navigate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(17, 153, 142, 0.3);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }

        .detour-slider {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .route-summary {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .results-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .results-container::-webkit-scrollbar {
            width: 8px;
        }

        .results-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .results-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .legend {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõï Divya Desam Locator</h1>
            <p>Interactive map and route planner for 108 sacred Vishnu temples</p>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="window.switchTab('nearby')">üìç Nearby Temples</button>
                    <button class="tab-btn" onclick="window.switchTab('route')">üó∫Ô∏è Route Planner</button>
                </div>

                <div id="nearbyTab" class="tab-content active">
                    <button class="btn-locate" onclick="window.findNearestTemples()">
                        üìç Find My Location
                    </button>
                    
                    <div class="loading" id="loading" style="display:none;">
                        <div class="loading-spinner"></div>
                        <p>Locating nearest temples...</p>
                    </div>

                    <div class="error" id="error" style="display:none;"></div>

                    <div class="results-container" id="nearbyResults"></div>
                </div>

                <div id="routeTab" class="tab-content">
                    <div class="autocomplete-container">
                        <span class="input-icon">üìç</span>
                        <input type="text" 
                               id="startPoint" 
                               class="route-input" 
                               placeholder="Start typing city name..."
                               autocomplete="off">
                        <div id="startAutocomplete" class="autocomplete-list"></div>
                    </div>

                    <div class="autocomplete-container">
                        <span class="input-icon">üèÅ</span>
                        <input type="text" 
                               id="endPoint" 
                               class="route-input" 
                               placeholder="Destination city..."
                               autocomplete="off">
                        <div id="endAutocomplete" class="autocomplete-list"></div>
                    </div>

                    <div class="detour-slider">
                        <label style="display: block; margin-bottom: 10px; font-weight: 500;">
                            Maximum detour: <span id="detourValue">25</span> km
                        </label>
                        <input type="range" id="detourRange" class="slider" min="5" max="100" value="25">
                    </div>

                    <button class="btn-locate" onclick="window.planRoute()">
                        üõï Find Temples Along Route
                    </button>

                    <div id="routeLoading" style="display:none;" class="loading">
                        <div class="loading-spinner"></div>
                        <p>Planning your spiritual journey...</p>
                    </div>

                    <div id="routeError" style="display:none;" class="error"></div>

                    <div class="results-container" id="routeResults"></div>
                </div>

                <div class="legend">
                    <strong>Map Legend:</strong>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #667eea;"></div>
                        <span>Divya Desam Temples</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff6b6b;"></div>
                        <span>Your Location</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #38ef7d;"></div>
                        <span>Selected Temple</span>
                    </div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
    
    <script>
        // Cities database with coordinates
        const cities = [
            // Tamil Nadu
            { name: "Chennai", state: "Tamil Nadu", lat: 13.0827, lng: 80.2707 },
            { name: "Madurai", state: "Tamil Nadu", lat: 9.9252, lng: 78.1198 },
            { name: "Coimbatore", state: "Tamil Nadu", lat: 11.0168, lng: 76.9558 },
            { name: "Thanjavur", state: "Tamil Nadu", lat: 10.7870, lng: 79.1378 },
            { name: "Trichy", state: "Tamil Nadu", lat: 10.8505, lng: 78.6967 },
            { name: "Tiruchirappalli", state: "Tamil Nadu", lat: 10.8505, lng: 78.6967 },
            { name: "Kumbakonam", state: "Tamil Nadu", lat: 10.9617, lng: 79.3881 },
            { name: "Kanchipuram", state: "Tamil Nadu", lat: 12.8185, lng: 79.6947 },
            { name: "Srirangam", state: "Tamil Nadu", lat: 10.8620, lng: 78.6960 },
            { name: "Tirunelveli", state: "Tamil Nadu", lat: 8.7139, lng: 77.7567 },
            { name: "Rameswaram", state: "Tamil Nadu", lat: 9.2885, lng: 79.3129 },
            { name: "Kanyakumari", state: "Tamil Nadu", lat: 8.0883, lng: 77.5385 },
            { name: "Vellore", state: "Tamil Nadu", lat: 12.9165, lng: 79.1325 },
            { name: "Salem", state: "Tamil Nadu", lat: 11.6643, lng: 78.1460 },
            { name: "Erode", state: "Tamil Nadu", lat: 11.3410, lng: 77.7172 },
            { name: "Nagapattinam", state: "Tamil Nadu", lat: 10.7672, lng: 79.8449 },
            { name: "Chidambaram", state: "Tamil Nadu", lat: 11.3992, lng: 79.6935 },
            { name: "Mayiladuthurai", state: "Tamil Nadu", lat: 11.1018, lng: 79.6520 },
            { name: "Sirkazhi", state: "Tamil Nadu", lat: 11.2380, lng: 79.7340 },
            { name: "Tiruvallur", state: "Tamil Nadu", lat: 13.1231, lng: 79.9080 },
            { name: "Mahabalipuram", state: "Tamil Nadu", lat: 12.6172, lng: 80.1926 },
            { name: "Srivilliputhur", state: "Tamil Nadu", lat: 9.5120, lng: 77.6337 },
            { name: "Thoothukudi", state: "Tamil Nadu", lat: 8.7642, lng: 78.1348 },
            { name: "Sholinghur", state: "Tamil Nadu", lat: 13.1181, lng: 79.4200 },
            // Kerala
            { name: "Thiruvananthapuram", state: "Kerala", lat: 8.5241, lng: 76.9366 },
            { name: "Trivandrum", state: "Kerala", lat: 8.5241, lng: 76.9366 },
            { name: "Kochi", state: "Kerala", lat: 9.9312, lng: 76.2673 },
            { name: "Cochin", state: "Kerala", lat: 9.9312, lng: 76.2673 },
            { name: "Kozhikode", state: "Kerala", lat: 11.2588, lng: 75.7804 },
            { name: "Calicut", state: "Kerala", lat: 11.2588, lng: 75.7804 },
            { name: "Thrissur", state: "Kerala", lat: 10.5276, lng: 76.2144 },
            { name: "Kollam", state: "Kerala", lat: 8.8932, lng: 76.6141 },
            { name: "Palakkad", state: "Kerala", lat: 10.7867, lng: 76.6548 },
            { name: "Alappuzha", state: "Kerala", lat: 9.4981, lng: 76.3388 },
            { name: "Tiruvalla", state: "Kerala", lat: 9.3816, lng: 76.5775 },
            { name: "Chengannur", state: "Kerala", lat: 9.3189, lng: 76.6157 },
            // Karnataka
            { name: "Bangalore", state: "Karnataka", lat: 12.9716, lng: 77.5946 },
            { name: "Bengaluru", state: "Karnataka", lat: 12.9716, lng: 77.5946 },
            { name: "Mysore", state: "Karnataka", lat: 12.2958, lng: 76.6394 },
            { name: "Mysuru", state: "Karnataka", lat: 12.2958, lng: 76.6394 },
            { name: "Mangalore", state: "Karnataka", lat: 12.9141, lng: 74.8560 },
            { name: "Mangaluru", state: "Karnataka", lat: 12.9141, lng: 74.8560 },
            { name: "Hubli", state: "Karnataka", lat: 15.3647, lng: 75.1240 },
            { name: "Belgaum", state: "Karnataka", lat: 15.8497, lng: 74.4977 },
            { name: "Shimoga", state: "Karnataka", lat: 13.9299, lng: 75.5681 },
            // Andhra Pradesh & Telangana
            { name: "Hyderabad", state: "Telangana", lat: 17.3850, lng: 78.4867 },
            { name: "Tirupati", state: "Andhra Pradesh", lat: 13.6288, lng: 79.4192 },
            { name: "Vijayawada", state: "Andhra Pradesh", lat: 16.5062, lng: 80.6480 },
            { name: "Visakhapatnam", state: "Andhra Pradesh", lat: 17.6868, lng: 83.2185 },
            { name: "Guntur", state: "Andhra Pradesh", lat: 16.3067, lng: 80.4365 },
            { name: "Nellore", state: "Andhra Pradesh", lat: 14.4426, lng: 79.9865 },
            { name: "Ahobilam", state: "Andhra Pradesh", lat: 15.1342, lng: 78.6742 },
            { name: "Tirumala", state: "Andhra Pradesh", lat: 13.6833, lng: 79.3473 },
            // Union Territory
            { name: "Puducherry", state: "Puducherry", lat: 11.9416, lng: 79.8083 },
            { name: "Pondicherry", state: "Puducherry", lat: 11.9416, lng: 79.8083 },
            // North India
            { name: "Delhi", state: "Delhi", lat: 28.6139, lng: 77.2090 },
            { name: "New Delhi", state: "Delhi", lat: 28.6139, lng: 77.2090 },
            { name: "Mathura", state: "Uttar Pradesh", lat: 27.4924, lng: 77.6737 },
            { name: "Vrindavan", state: "Uttar Pradesh", lat: 27.5815, lng: 77.6968 },
            { name: "Gokul", state: "Uttar Pradesh", lat: 27.4425, lng: 77.7211 },
            { name: "Ayodhya", state: "Uttar Pradesh", lat: 26.7922, lng: 82.1998 },
            { name: "Varanasi", state: "Uttar Pradesh", lat: 25.3176, lng: 82.9739 },
            { name: "Lucknow", state: "Uttar Pradesh", lat: 26.8467, lng: 80.9462 },
            { name: "Agra", state: "Uttar Pradesh", lat: 27.1767, lng: 78.0081 },
            { name: "Naimisaranya", state: "Uttar Pradesh", lat: 27.1287, lng: 80.5308 },
            // Uttarakhand
            { name: "Badrinath", state: "Uttarakhand", lat: 30.7433, lng: 79.4938 },
            { name: "Haridwar", state: "Uttarakhand", lat: 29.9457, lng: 78.1642 },
            { name: "Rishikesh", state: "Uttarakhand", lat: 30.0869, lng: 78.2676 },
            { name: "Devprayag", state: "Uttarakhand", lat: 30.1461, lng: 78.5989 },
            { name: "Nandaprayag", state: "Uttarakhand", lat: 30.3286, lng: 79.3269 },
            // Gujarat
            { name: "Dwarka", state: "Gujarat", lat: 22.2376, lng: 68.9674 },
            { name: "Ahmedabad", state: "Gujarat", lat: 23.0225, lng: 72.5714 },
            { name: "Surat", state: "Gujarat", lat: 21.1702, lng: 72.8311 },
            { name: "Vadodara", state: "Gujarat", lat: 22.3072, lng: 73.1812 },
            { name: "Rajkot", state: "Gujarat", lat: 22.3039, lng: 70.8022 }
        ];

        // Divya Desam temples data
        const divyaDesams = [
            // Chola Nadu Divya Desams
            { name: "ThiruArangam", displayName: "Sri Ranganathaswamy Temple, Srirangam", lat: 10.8620, lng: 78.6960, link: "https://www.google.com/maps/search/?api=1&query=Sri+Ranganathaswamy+Temple,+Srirangam" },
            { name: "ThiruKoazhi", displayName: "Nachiyar Koil", lat: 10.9485, lng: 79.4745, link: "https://www.google.com/maps/search/?api=1&query=Nachiyar+Koil,+Thirunaraiyur" },
            { name: "ThiruKarambanoor", displayName: "Uthamar Kovil", lat: 10.8145, lng: 78.8985, link: "https://www.google.com/maps/search/?api=1&query=Uthamar+Kovil,+Pichandar+Koil" },
            { name: "ThiruVellarai", displayName: "Pundarikakshan Perumal Temple", lat: 10.8533, lng: 78.5742, link: "https://www.google.com/maps/search/?api=1&query=Pundarikakshan+Perumal+Temple,+Thiruvellarai" },
            { name: "ThiruAnbil", displayName: "Sundararaja Perumal Temple, Anbil", lat: 10.8372, lng: 78.8158, link: "https://www.google.com/maps/search/?api=1&query=Sundararaja+Perumal+Temple,+Anbil" },
            { name: "ThiruPer Nagar", displayName: "Appakkudathaan Perumal Temple", lat: 10.8645, lng: 78.7810, link: "https://www.google.com/maps/search/?api=1&query=Appakkudathaan+Perumal+Temple,+Koviladi" },
            { name: "ThiruKandiyur", displayName: "Hara Saabha Vimocchana Temple", lat: 11.0740, lng: 79.4525, link: "https://www.google.com/maps/search/?api=1&query=Hara+Saabha+Vimocchana+Perumal+Temple,+Kandiyur" },
            { name: "ThiruKoodalur", displayName: "Aduthurai Perumal Kovil", lat: 10.9945, lng: 79.4819, link: "https://www.google.com/maps/search/?api=1&query=Aduthurai+Perumal+Kovil,+Thirukoodalur" },
            { name: "ThiruKavithalam", displayName: "Gajendra Varadha Temple", lat: 10.9729, lng: 79.3740, link: "https://www.google.com/maps/search/?api=1&query=Gajendra+Varadha+Perumal+Temple,+Kabisthalam" },
            { name: "ThiruPullam boothangudi", displayName: "Valvil Raman Temple", lat: 10.9344, lng: 79.2511, link: "https://www.google.com/maps/search/?api=1&query=Valvil+Raman+Perumal+Temple,+Pullabhoothangudi" },
            { name: "ThiruAthanoor", displayName: "Aandalum Akkum Aayan Temple", lat: 10.8856, lng: 79.3642, link: "https://www.google.com/maps/search/?api=1&query=Aandalum+Akkum+Aayan+Perumal+Temple,+Athanoor" },
            { name: "ThiruKudanthai", displayName: "Sarangapani Temple, Kumbakonam", lat: 10.9617, lng: 79.3881, link: "https://www.google.com/maps/search/?api=1&query=Sarangapani+Temple,+Kumbakonam" },
            { name: "ThiruVinnagar", displayName: "Oppiliappan Temple", lat: 10.9156, lng: 79.2997, link: "https://www.google.com/maps/search/?api=1&query=Oppiliappan+Temple,+Thirunageswaram,+Kumbakonam" },
            { name: "ThiruNaraiyur", displayName: "Nachiyar Koil, Thirunaraiyur", lat: 10.9485, lng: 79.4745, link: "https://www.google.com/maps/search/?api=1&query=Nachiyar+Koil,+Thirunaraiyur" },
            { name: "ThiruCherai", displayName: "Saranathan Perumal Temple", lat: 10.9313, lng: 79.2850, link: "https://www.google.com/maps/search/?api=1&query=Saranathan+Perumal+Temple,+Thirucherai" },
            { name: "ThiruKannamangai", displayName: "Bhaktavatsala Perumal Temple", lat: 10.8583, lng: 79.0750, link: "https://www.google.com/maps/search/?api=1&query=Bhaktavatsala+Perumal+Temple,+Thirukannamangai" },
            { name: "ThiruKannapuram", displayName: "Neelamegha Perumal Temple", lat: 10.8944, lng: 79.2197, link: "https://www.google.com/maps/search/?api=1&query=Neelamegha+Perumal+Temple,+Thirukannapuram" },
            { name: "ThiruKannangudi", displayName: "Lokanantha Perumal Temple", lat: 10.3517, lng: 79.4183, link: "https://www.google.com/maps/search/?api=1&query=Lokanantha+Perumal+Temple,+Thirukannangudi" },
            { name: "ThiruNaagai", displayName: "Soundararaja Temple, Nagapattinam", lat: 10.7672, lng: 79.8449, link: "https://www.google.com/maps/search/?api=1&query=Soundararajaperumal+Temple,+Nagapattinam" },
            { name: "ThiruThanjai Maamani Kovil", displayName: "Thanjai Maamani Koil", lat: 10.7870, lng: 79.1378, link: "https://www.google.com/maps/search/?api=1&query=Thanjai+Maamani+Koil,+Thanjavur" },
            { name: "ThiruNandipura Vinnagaram", displayName: "Nathan Kovil, Thanjavur", lat: 10.8150, lng: 79.1100, link: "https://www.google.com/maps/search/?api=1&query=Nathan+Kovil,+Jagannatha+Perumal,+Thanjavur" },
            { name: "ThiruVelliyangudi", displayName: "Kola Valvilli Ramar Temple", lat: 10.5889, lng: 79.0972, link: "https://www.google.com/maps/search/?api=1&query=Kola+Valvilli+Ramar+Temple,+Thiruvelliyangudi" },
            { name: "ThiruAzhundhur", displayName: "Devadiraja Perumal Temple", lat: 10.8800, lng: 79.2350, link: "https://www.google.com/maps/search/?api=1&query=Devadiraja+Perumal+Temple,+Therezhundur" },
            { name: "ThiruChirupuliyoor", displayName: "Arulmaakadal Perumal Temple", lat: 11.3981, lng: 79.7064, link: "https://www.google.com/maps/search/?api=1&query=Arulmaakadal+Perumal+Temple,+Sirupuliyur" },
            { name: "ThiruThalaichanganaanmadhiyam", displayName: "Naanmadhia Perumal Temple", lat: 11.1933, lng: 79.5500, link: "https://www.google.com/maps/search/?api=1&query=Naanmadhia+Perumal+Temple,+Thalaichangadu" },
            { name: "ThiruIndhalur", displayName: "Parimala Ranganathar Temple", lat: 11.1018, lng: 79.6520, link: "https://www.google.com/maps/search/?api=1&query=Parimala+Ranganathar+Temple,+Mayiladuthurai" },
            { name: "ThiruKavalambadi", displayName: "Gopalakrishna Perumal Temple", lat: 11.1670, lng: 79.4830, link: "https://www.google.com/maps/search/?api=1&query=Gopalakrishna+Perumal+Temple,+Thirukavalambadi" },
            // Sirkazhi cluster
            { name: "ThiruKaazhisrirama Vinnagaram", displayName: "Trivikrama Perumal Temple", lat: 11.2380, lng: 79.7340, link: "https://www.google.com/maps/search/?api=1&query=Trivikrama+Perumal+Temple,+Sirkazhi" },
            { name: "ThiruArimeya Vinnagaram", displayName: "Kudamudakoothan Temple", lat: 11.2450, lng: 79.7310, link: "https://www.google.com/maps/search/?api=1&query=Kudamudakoothan+Perumal+Temple,+Sirkazhi" },
            { name: "ThiruVanpurushothamam", displayName: "Purushothama Temple", lat: 11.2420, lng: 79.7290, link: "https://www.google.com/maps/search/?api=1&query=Purushothama+Perumal+Temple,+Sirkazhi" },
            { name: "ThiruSemponsei Kovil", displayName: "Sempon Sei Arangar Temple", lat: 11.2350, lng: 79.7380, link: "https://www.google.com/maps/search/?api=1&query=Sempon+Sei+Arangar+Temple,+Sirkazhi" },
            { name: "ThiruManimaada Kovil", displayName: "Narayana Temple", lat: 11.2410, lng: 79.7360, link: "https://www.google.com/maps/search/?api=1&query=Narayana+Perumal+Temple,+Thirumanimadam,+Sirkazhi" },
            { name: "ThiruVaikuntha Vinnagaram", displayName: "Vaikunda Natha Temple", lat: 11.2390, lng: 79.7320, link: "https://www.google.com/maps/search/?api=1&query=Vaikunda+Natha+Perumal+Temple,+Sirkazhi" },
            { name: "ThiruAali", displayName: "Thiruvali Thirunagari", lat: 11.2297, lng: 79.7486, link: "https://www.google.com/maps/search/?api=1&query=Thiruvali+Thirunagari+Temples" },
            { name: "ThiruThevanaarthogai", displayName: "Deivanayaga Temple", lat: 11.2360, lng: 79.7350, link: "https://www.google.com/maps/search/?api=1&query=Deivanayaga+Perumal+Temple,+Sirkazhi" },
            { name: "ThiruThetriyambalam", displayName: "Palli Konda Temple", lat: 11.2370, lng: 79.7330, link: "https://www.google.com/maps/search/?api=1&query=Palli+Konda+Perumal+Temple,+Sirkazhi" },
            { name: "ThiruManikkoodam", displayName: "Varadharaja Temple", lat: 11.2203, lng: 79.4547, link: "https://www.google.com/maps/search/?api=1&query=Varadharaja+Perumal+Temple,+Thirumanikkoodam" },
            { name: "ThiruVellakkulam", displayName: "Srinivasa Temple", lat: 11.2950, lng: 79.8325, link: "https://www.google.com/maps/search/?api=1&query=Srinivasa+Perumal+Temple,+Thiruvellakkulam" },
            { name: "ThiruParthan Palli", displayName: "Thamaraiyal Kelvan Temple", lat: 11.2700, lng: 79.5500, link: "https://www.google.com/maps/search/?api=1&query=Thamaraiyal+Kelvan+Perumal+Temple,+Thirupparthanpalli" },
            // Cuddalore region
            { name: "ThiruChithrakootam", displayName: "Govindaraja Temple, Chidambaram", lat: 11.3992, lng: 79.6935, link: "https://www.google.com/maps/search/?api=1&query=Govindaraja+Perumal+Temple,+Chidambaram" },
            { name: "ThiruAheendrapuram", displayName: "Devanatha Temple", lat: 11.5125, lng: 79.6333, link: "https://www.google.com/maps/search/?api=1&query=Devanatha+Perumal+Temple,+Thiruvahindrapuram" },
            { name: "ThiruKovalur", displayName: "Ulagalantha Temple, Tirukoyilur", lat: 11.9678, lng: 79.2833, link: "https://www.google.com/maps/search/?api=1&query=Ulagalantha+Perumal+Temple,+Tirukoyilur" },
            
            // Kanchipuram Region
            { name: "ThiruKachchi", displayName: "Varadharaja Perumal Temple, Kanchipuram", lat: 12.8185, lng: 79.6947, link: "https://www.google.com/maps/search/?api=1&query=Varadharaja+Perumal+Temple,+Kanchipuram" },
            { name: "ThiruAttabuyakaram", displayName: "Ashtabujakaram Temple, Kanchipuram", lat: 12.8172, lng: 79.6953, link: "https://www.google.com/maps/search/?api=1&query=Ashtabujakaram+Temple,+Kanchipuram" },
            { name: "ThiruThankaa", displayName: "Vilakkoli Perumal Temple, Kanchipuram", lat: 12.8190, lng: 79.6940, link: "https://www.google.com/maps/search/?api=1&query=Vilakkoli+Perumal+Temple,+Kanchipuram" },
            { name: "ThiruVelukkai", displayName: "Azhagiya Singar Perumal Temple, Kanchipuram", lat: 12.8195, lng: 79.6935, link: "https://www.google.com/maps/search/?api=1&query=Azhagiya+Singar+Perumal+Temple,+Kanchipuram" },
            { name: "ThiruNeeragam", displayName: "Neeragathan Temple, Kanchipuram", lat: 12.8180, lng: 79.6945, link: "https://www.google.com/maps/search/?api=1&query=Neeragathan+Temple,+Ulagalantha+Perumal+Temple,+Kanchipuram" },
            { name: "ThiruPaadagam", displayName: "Pandava Thoothar Perumal Temple, Kanchipuram", lat: 12.8175, lng: 79.6950, link: "https://www.google.com/maps/search/?api=1&query=Pandava+Thoothar+Perumal+Temple,+Kanchipuram" },
            { name: "ThiruNilathingal Thundam", displayName: "Nilathingal Thundathan Perumal, Kanchipuram", lat: 12.8188, lng: 79.6942, link: "https://www.google.com/maps/search/?api=1&query=Nilathingal+Thundathan+Perumal+Sannidhi,+Kanchipuram" },
            { name: "ThiruOoragam", displayName: "Ulagalantha Perumal Temple, Kanchipuram", lat: 12.8183, lng: 79.6948, link: "https://www.google.com/maps/search/?api=1&query=Ulagalantha+Perumal+Temple,+Kanchipuram" },
            { name: "ThiruVeggaa", displayName: "Yathothkari Perumal Temple, Kanchipuram", lat: 12.8177, lng: 79.6952, link: "https://www.google.com/maps/search/?api=1&query=Yathothkari+Perumal+Temple,+Kanchipuram" },
            { name: "ThiruKaragam", displayName: "Karunakara Perumal Temple, Kanchipuram", lat: 12.8181, lng: 79.6946, link: "https://www.google.com/maps/search/?api=1&query=Karunakara+Perumal+Temple,+Ulagalantha+Perumal+Temple,+Kanchipuram" },
            { name: "ThiruKarvanam", displayName: "Karvanar Temple, Kanchipuram", lat: 12.8186, lng: 79.6944, link: "https://www.google.com/maps/search/?api=1&query=Karvanar+Temple,+Ulagalantha+Perumal+Temple,+Kanchipuram" },
            { name: "ThiruKalvanur", displayName: "Kalvar Perumal, Kanchipuram", lat: 12.8184, lng: 79.6949, link: "https://www.google.com/maps/search/?api=1&query=Kalvar+Perumal+Sannidhi,+Kamakshi+Amman+Temple,+Kanchipuram" },
            { name: "ThiruPavalavannam", displayName: "Pavalavannar Temple, Kanchipuram", lat: 12.8179, lng: 79.6951, link: "https://www.google.com/maps/search/?api=1&query=Pavalavannar+Temple,+Kanchipuram" },
            { name: "ThiruParameswara Vinnagaram", displayName: "Vaikunta Perumal Temple, Kanchipuram", lat: 12.8205, lng: 79.6915, link: "https://www.google.com/maps/search/?api=1&query=Vaikunta+Perumal+Temple,+Kanchipuram" },
            
            // Chennai Region
            { name: "ThiruPutkuzhi", displayName: "Vijayaraghava Perumal Temple, Thiruputkuzhi", lat: 13.1045, lng: 79.3125, link: "https://www.google.com/maps/search/?api=1&query=Vijayaraghava+Perumal+Temple,+Thiruputkuzhi" },
            { name: "ThiruNindravur", displayName: "Bhakthavatsala Perumal Temple, Thirunindravur", lat: 13.1231, lng: 79.9080, link: "https://www.google.com/maps/search/?api=1&query=Bhakthavatsala+Perumal+Temple,+Thirunindravur" },
            { name: "ThiruEvvul", displayName: "Veeraraghava Perumal Temple, Thiruvallur", lat: 13.1181, lng: 79.4200, link: "https://www.google.com/maps/search/?api=1&query=Veeraraghava+Perumal+Temple,+Thiruvallur" },
            { name: "ThiruAllikkeni", displayName: "Parthasarathy Temple, Chennai", lat: 13.0361, lng: 80.2675, link: "https://www.google.com/maps/search/?api=1&query=Parthasarathy+Temple,+Thiruvallikeni,+Chennai" },
            { name: "ThiruNeermalai", displayName: "Neervanna Perumal Temple, Thiruneermalai", lat: 12.9394, lng: 80.1789, link: "https://www.google.com/maps/search/?api=1&query=Neervanna+Perumal+Temple,+Thiruneermalai" },
            { name: "ThiruIdaventhai", displayName: "Nithya Kalyana Perumal Temple, Thiruvidanthai", lat: 12.6175, lng: 80.1875, link: "https://www.google.com/maps/search/?api=1&query=Nithya+Kalyana+Perumal+Temple,+Thiruvidanthai" },
            { name: "ThiruKadanmallai", displayName: "Sthalasayana Perumal Temple, Mahabalipuram", lat: 12.6172, lng: 80.1926, link: "https://www.google.com/maps/search/?api=1&query=Sthalasayana+Perumal+Temple,+Mahabalipuram" },
            { name: "ThiruKadigai", displayName: "Yoga Narasimha Swamy Temple, Sholinghur", lat: 13.1181, lng: 79.4200, link: "https://www.google.com/maps/search/?api=1&query=Yoga+Narasimha+Swamy+Temple,+Sholinghur" },
            
            // North India
            { name: "ThiruAyodhi", displayName: "Ayodhya, Uttar Pradesh", lat: 26.7922, lng: 82.1998, link: "https://www.google.com/maps/search/?api=1&query=Ayodhya,+Uttar+Pradesh" },
            { name: "ThiruNaimisaranyam", displayName: "Naimisaranya, Uttar Pradesh", lat: 27.1287, lng: 80.5308, link: "https://www.google.com/maps/search/?api=1&query=Naimisaranya,+Uttar+Pradesh" },
            { name: "ThiruPiruthi", displayName: "Nandaprayag, Uttarakhand", lat: 30.3286, lng: 79.3269, link: "https://www.google.com/maps/search/?api=1&query=Nandaprayag,+Uttarakhand" },
            { name: "ThiruKandamennum Kadinagar", displayName: "Devprayag, Uttarakhand", lat: 30.1461, lng: 78.5989, link: "https://www.google.com/maps/search/?api=1&query=Devprayag,+Uttarakhand" },
            { name: "ThiruVadari", displayName: "Badrinath Temple, Uttarakhand", lat: 30.7433, lng: 79.4938, link: "https://www.google.com/maps/search/?api=1&query=Badrinath+Temple,+Uttarakhand" },
            { name: "ThiruSalagraamam", displayName: "Muktinath Temple, Nepal", lat: 28.8176, lng: 83.8665, link: "https://www.google.com/maps/search/?api=1&query=Muktinath+Temple,+Nepal" },
            { name: "ThiruVada Madurai", displayName: "Mathura, Uttar Pradesh", lat: 27.4924, lng: 77.6737, link: "https://www.google.com/maps/search/?api=1&query=Mathura,+Uttar+Pradesh" },
            { name: "ThiruAyppaadi", displayName: "Gokul, Uttar Pradesh", lat: 27.4425, lng: 77.7211, link: "https://www.google.com/maps/search/?api=1&query=Gokul,+Uttar+Pradesh" },
            { name: "ThiruThuvarai", displayName: "Dwarkadhish Temple, Gujarat", lat: 22.2376, lng: 68.9674, link: "https://www.google.com/maps/search/?api=1&query=Dwarkadhish+Temple,+Dwarka,+Gujarat" },
            
            // Andhra Pradesh
            { name: "ThiruSingavelkundram", displayName: "Ahobilam, Andhra Pradesh", lat: 15.1342, lng: 78.6742, link: "https://www.google.com/maps/search/?api=1&query=Ahobilam,+Andhra+Pradesh" },
            { name: "ThiruVenkatam", displayName: "Venkateswara Temple, Tirumala", lat: 13.6833, lng: 79.3473, link: "https://www.google.com/maps/search/?api=1&query=Venkateswara+Temple,+Tirumala,+Andhra+Pradesh" },
            
            // Kerala
            { name: "ThiruNaavaai", displayName: "Navamukunda Temple, Tirunavaya", lat: 11.1565, lng: 75.9604, link: "https://www.google.com/maps/search/?api=1&query=Navamukunda+Temple,+Tirunavaya,+Kerala" },
            { name: "ThiruViththuvakkodu", displayName: "Uyyavantha Perumal Temple, Thiruvithuvacode", lat: 9.4167, lng: 76.5833, link: "https://www.google.com/maps/search/?api=1&query=Uyyavantha+Perumal+Temple,+Thiruvithuvacode,+Kerala" },
            { name: "ThiruKaatkarai", displayName: "Thrikkakara Vamana Moorthy Temple, Kerala", lat: 9.9711, lng: 76.3458, link: "https://www.google.com/maps/search/?api=1&query=Thrikkakara+Vamana+Moorthy+Temple,+Kerala" },
            { name: "ThiruMoozhikkalam", displayName: "Moozhikkulam Lakshmana Perumal Temple, Kerala", lat: 10.7867, lng: 76.2144, link: "https://www.google.com/maps/search/?api=1&query=Moozhikkulam+Lakshmana+Perumal+Temple,+Kerala" },
            { name: "ThiruVallavaazh", displayName: "Sreevallabha Temple, Tiruvalla", lat: 9.3816, lng: 76.5775, link: "https://www.google.com/maps/search/?api=1&query=Sreevallabha+Temple,+Tiruvalla,+Kerala" },
            { name: "ThiruKadithaanam", displayName: "Thrikodithanam Mahavishnu Temple, Kerala", lat: 9.4167, lng: 76.5500, link: "https://www.google.com/maps/search/?api=1&query=Thrikodithanam+Mahavishnu+Temple,+Kerala" },
            { name: "ThiruChenkundrur", displayName: "Imayavarappan Perumal Temple, Chengannur", lat: 9.3189, lng: 76.6157, link: "https://www.google.com/maps/search/?api=1&query=Imayavarappan+Perumal+Temple,+Chengannur,+Kerala" },
            { name: "ThiruPuliyur", displayName: "Thirupuliyur Mahavishnu Temple, Kerala", lat: 9.3000, lng: 76.6000, link: "https://www.google.com/maps/search/?api=1&query=Thirupuliyur+Mahavishnu+Temple,+Kerala" },
            { name: "ThiruVaaranvilai", displayName: "Aranmula Parthasarathy Temple, Kerala", lat: 9.2900, lng: 76.6700, link: "https://www.google.com/maps/search/?api=1&query=Aranmula+Parthasarathy+Temple,+Kerala" },
            { name: "ThiruVanvandur", displayName: "Thiruvanvandoor Mahavishnu Temple, Kerala", lat: 9.2800, lng: 76.6500, link: "https://www.google.com/maps/search/?api=1&query=Thiruvanvandoor+Mahavishnu+Temple,+Kerala" },
            { name: "ThiruAnanthapuram", displayName: "Padmanabhaswamy Temple, Thiruvananthapuram", lat: 8.5241, lng: 76.9366, link: "https://www.google.com/maps/search/?api=1&query=Padmanabhaswamy+Temple,+Thiruvananthapuram,+Kerala" },
            
            // Southern Tamil Nadu
            { name: "ThiruVaattaaru", displayName: "Adikesava Perumal Temple, Thiruvattar", lat: 8.1833, lng: 77.1667, link: "https://www.google.com/maps/search/?api=1&query=Adikesava+Perumal+Temple,+Thiruvattar,+Tamil+Nadu" },
            { name: "ThiruVannparisaaram", displayName: "Thiruvazhmarban Temple, Thirupathisaram", lat: 8.2500, lng: 77.2000, link: "https://www.google.com/maps/search/?api=1&query=Thiruvazhmarban+Temple,+Thirupathisaram,+Tamil+Nadu" },
            { name: "ThiruKurungudi", displayName: "Azhagiya Nambi Perumal Temple, Thirukkurungudi", lat: 8.7139, lng: 77.7567, link: "https://www.google.com/maps/search/?api=1&query=Azhagiya+Nambi+Perumal+Temple,+Thirukkurungudi" },
            { name: "ThiruChireevaramangai", displayName: "Vanamamalai Perumal Temple, Nanguneri", lat: 8.4833, lng: 77.6833, link: "https://www.google.com/maps/search/?api=1&query=Vanamamalai+Perumal+Temple,+Nanguneri" },
            
            // Nava Tirupathi
            { name: "ThiruVaikuntam", displayName: "Vaikunta Perumal Temple, Srivaikuntam", lat: 8.6167, lng: 77.9167, link: "https://www.google.com/maps/search/?api=1&query=Nava+Tirupathi,+Srivaikuntam,+Thoothukudi" },
            { name: "ThiruVaragunamangai", displayName: "Varagunamangai Temple, Srivaikuntam", lat: 8.6200, lng: 77.9200, link: "https://www.google.com/maps/search/?api=1&query=Nava+Tirupathi,+Srivaikuntam,+Thoothukudi" },
            { name: "ThiruPulingudi", displayName: "Pulingudi Temple, Srivaikuntam", lat: 8.6233, lng: 77.9233, link: "https://www.google.com/maps/search/?api=1&query=Nava+Tirupathi,+Srivaikuntam,+Thoothukudi" },
            { name: "ThiruThulaivillimangalam", displayName: "Thulaivillimangalam Temple, Srivaikuntam", lat: 8.6266, lng: 77.9266, link: "https://www.google.com/maps/search/?api=1&query=Nava+Tirupathi,+Srivaikuntam,+Thoothukudi" },
            { name: "ThiruKulandhai", displayName: "Kulandhai Temple, Srivaikuntam", lat: 8.6300, lng: 77.9300, link: "https://www.google.com/maps/search/?api=1&query=Nava+Tirupathi,+Srivaikuntam,+Thoothukudi" },
            { name: "ThiruKolur", displayName: "Kolur Temple, Srivaikuntam", lat: 8.6333, lng: 77.9333, link: "https://www.google.com/maps/search/?api=1&query=Nava+Tirupathi,+Srivaikuntam,+Thoothukudi" },
            { name: "ThiruPerai", displayName: "Perai Temple, Srivaikuntam", lat: 8.6366, lng: 77.9366, link: "https://www.google.com/maps/search/?api=1&query=Nava+Tirupathi,+Srivaikuntam,+Thoothukudi" },
            { name: "ThiruKurugur", displayName: "Kurugur Temple, Alwarthirunagari", lat: 8.6400, lng: 77.9400, link: "https://www.google.com/maps/search/?api=1&query=Nava+Tirupathi,+Alwarthirunagari,+Thoothukudi" },
            
            // Pandya Nadu
            { name: "ThiruVilliputhur", displayName: "Srivilliputhur Andal Temple", lat: 9.5120, lng: 77.6337, link: "https://www.google.com/maps/search/?api=1&query=Srivilliputhur+Andal+Temple" },
            { name: "ThiruThankaal", displayName: "Ninra Narayana Perumal Temple, Thiruthangal", lat: 9.4833, lng: 77.8167, link: "https://www.google.com/maps/search/?api=1&query=Ninra+Narayana+Perumal+Temple,+Thiruthangal" },
            { name: "ThiruKudal", displayName: "Koodal Azhagar Temple, Madurai", lat: 9.9252, lng: 78.1198, link: "https://www.google.com/maps/search/?api=1&query=Koodal+Azhagar+Temple,+Madurai" },
            { name: "ThiruMaaliruncholai", displayName: "Alagar Kovil, Madurai", lat: 9.8667, lng: 78.0667, link: "https://www.google.com/maps/search/?api=1&query=Alagar+Kovil,+Madurai" },
            { name: "ThiruMogur", displayName: "Kalamega Perumal Temple, Thirumohur", lat: 9.8500, lng: 78.1500, link: "https://www.google.com/maps/search/?api=1&query=Kalamega+Perumal+Temple,+Thirumohur" },
            { name: "ThiruKottiyur", displayName: "Sowmya Narayana Perumal Temple, Thirukoshtiyur", lat: 9.7667, lng: 78.2167, link: "https://www.google.com/maps/search/?api=1&query=Sowmya+Narayana+Perumal+Temple,+Thirukoshtiyur" },
            { name: "ThiruPullaani", displayName: "Adi Jagannatha Perumal Temple, Thiruppullani", lat: 9.2885, lng: 79.3129, link: "https://www.google.com/maps/search/?api=1&query=Adi+Jagannatha+Perumal+Temple,+Thiruppullani" },
            { name: "ThiruMeyyam", displayName: "Sathyamurthi Perumal Temple, Thirumayam", lat: 9.5667, lng: 78.4167, link: "https://www.google.com/maps/search/?api=1&query=Sathyamurthi+Perumal+Temple,+Thirumayam" }
        ];

        // Global variables
        let map;
        let userMarker;
        let templeMarkers = [];
        let routeControl;
        let userLocation = null;

        // Initialize map
        function initMap() {
            map = L.map('map').setView([10.8505, 78.6967], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add all temple markers
            addTempleMarkers();
        }

        // Add temple markers to map
        function addTempleMarkers() {
            divyaDesams.forEach(temple => {
                const marker = L.marker([temple.lat, temple.lng], {
                    icon: L.divIcon({
                        className: 'temple-marker',
                        html: 'üõï',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);
                
                marker.bindPopup(`
                    <strong>${temple.displayName}</strong><br>
                    <a href="${temple.link}" target="_blank" class="btn-navigate">Get Directions</a>
                `);
                
                templeMarkers.push(marker);
            });
        }

        // Find nearest temples based on user location
        window.findNearestTemples = function() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const results = document.getElementById('nearbyResults');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            results.innerHTML = '';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        showNearestTemples(userLocation);
                        loading.style.display = 'none';
                    },
                    err => {
                        loading.style.display = 'none';
                        error.style.display = 'block';
                        error.textContent = 'Unable to get your location. Please enable location services.';
                    }
                );
            } else {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'Geolocation is not supported by this browser.';
            }
        };

        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Show nearest temples
        async function showNearestTemples(location) {
            // Add user marker
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            userMarker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    className: 'user-marker',
                    html: 'üìç',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);
            
            userMarker.bindPopup('Your Location');
            
            // Show loading message while calculating distances
            const results = document.getElementById('nearbyResults');
            results.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Calculating road distances...</p></div>';
            
            // Calculate road distances for all temples (in batches to avoid overwhelming the API)
            const templesWithDistance = [];
            const batchSize = 3; // Process 3 temples at a time (conservative)
            
            for (let i = 0; i < divyaDesams.length; i += batchSize) {
                const batch = divyaDesams.slice(i, i + batchSize);
                const batchPromises = batch.map(async temple => ({
                    ...temple,
                    distance: await calculateRoadDistance(location.lat, location.lng, temple.lat, temple.lng)
                }));
                
                const batchResults = await Promise.all(batchPromises);
                templesWithDistance.push(...batchResults);
                
                // Update progress
                const progress = Math.min(100, Math.round((templesWithDistance.length / divyaDesams.length) * 100));
                results.innerHTML = `<div class="loading"><div class="loading-spinner"></div><p>Calculating road distances... ${progress}%</p></div>`;
                
                // Longer delay to avoid rate limiting
                if (i + batchSize < divyaDesams.length) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            // Sort by distance and show results
            templesWithDistance.sort((a, b) => a.distance - b.distance);
            
            results.innerHTML = templesWithDistance.slice(0, 10).map(temple => `
                <div class="temple-card">
                    <div class="temple-name">${temple.displayName}</div>
                    <div class="temple-distance">
                        Road Distance: <strong>${temple.distance.toFixed(1)} km</strong>
                        <small style="color: #999; display: block;">${temple.isEstimated ? '(Estimated)' : '(Actual route)'}</small>
                    </div>
                    <a href="${temple.link}" target="_blank" class="btn-navigate">Get Directions</a>
                </div>
            `).join('');

            // Center map on user location
            map.setView([location.lat, location.lng], 10);
        }

        // Tab switching
        window.switchTab = function(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        };

        // Autocomplete functionality
        function setupAutocomplete() {
            const inputs = ['startPoint', 'endPoint'];
            
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                const autocompleteList = document.getElementById(inputId.replace('Point', 'Autocomplete'));
                
                input.addEventListener('input', function() {
                    const value = this.value.toLowerCase();
                    autocompleteList.innerHTML = '';
                    
                    if (value.length < 2) {
                        autocompleteList.classList.remove('active');
                        return;
                    }
                    
                    // Search in cities
                    const cityMatches = cities.filter(city => 
                        city.name.toLowerCase().includes(value) || 
                        city.state.toLowerCase().includes(value)
                    ).map(city => ({
                        ...city,
                        type: 'city',
                        searchName: city.name,
                        searchDescription: city.state
                    }));
                    
                    // Search in temple names and locations
                    const templeMatches = divyaDesams.filter(temple => 
                        temple.displayName.toLowerCase().includes(value) ||
                        temple.name.toLowerCase().includes(value)
                    ).map(temple => ({
                        lat: temple.lat,
                        lng: temple.lng,
                        type: 'temple',
                        searchName: temple.displayName,
                        searchDescription: 'Divya Desam Temple'
                    }));
                    
                    // Combine and limit results
                    const allMatches = [...cityMatches, ...templeMatches];
                    const matches = allMatches.slice(0, 8); // Show more results since we have temples too
                    
                    if (matches.length > 0) {
                        autocompleteList.innerHTML = matches.map(item => `
                            <div class="autocomplete-item" data-lat="${item.lat}" data-lng="${item.lng}" data-type="${item.type}">
                                <span class="city-name">${item.searchName}</span>
                                <span class="city-state ${item.type === 'temple' ? 'temple-type' : ''}">${item.searchDescription}</span>
                            </div>
                        `).join('');
                        autocompleteList.classList.add('active');
                        
                        // Add click handlers
                        autocompleteList.querySelectorAll('.autocomplete-item').forEach(item => {
                            item.addEventListener('click', function() {
                                input.value = this.querySelector('.city-name').textContent;
                                input.dataset.lat = this.dataset.lat;
                                input.dataset.lng = this.dataset.lng;
                                autocompleteList.classList.remove('active');
                            });
                        });
                    } else {
                        autocompleteList.classList.remove('active');
                    }
                });
                
                // Hide autocomplete when clicking outside
                document.addEventListener('click', function(e) {
                    if (!input.contains(e.target) && !autocompleteList.contains(e.target)) {
                        autocompleteList.classList.remove('active');
                    }
                });
            });
        }

        // Plan route functionality
        window.planRoute = function() {
            const startInput = document.getElementById('startPoint');
            const endInput = document.getElementById('endPoint');
            const detourRange = document.getElementById('detourRange');
            const loading = document.getElementById('routeLoading');
            const error = document.getElementById('routeError');
            const results = document.getElementById('routeResults');
            
            if (!startInput.dataset.lat || !endInput.dataset.lat) {
                error.style.display = 'block';
                error.textContent = 'Please select valid start and end locations from the suggestions.';
                return;
            }
            
            loading.style.display = 'block';
            error.style.display = 'none';
            results.innerHTML = '';
            
            const start = { lat: parseFloat(startInput.dataset.lat), lng: parseFloat(startInput.dataset.lng) };
            const end = { lat: parseFloat(endInput.dataset.lat), lng: parseFloat(endInput.dataset.lng) };
            const maxDetour = parseInt(detourRange.value);
            
            // Find temples along route with real road distances
            (async () => {
                try {
                    const templesAlongRoute = await findTemplesAlongRoute(start, end, maxDetour);
                    loading.style.display = 'none';
                    
                    if (templesAlongRoute.length > 0) {
                        results.innerHTML = `
                            <div class="route-summary">
                                <strong>Found ${templesAlongRoute.length} temples along your route</strong><br>
                                Route: ${startInput.value} ‚Üí ${endInput.value}<br>
                                <small>Using actual road distances via OpenRoute Service</small>
                            </div>
                            ${templesAlongRoute.map(temple => `
                                <div class="temple-card">
                                    <div class="temple-name">${temple.displayName}</div>
                                    <div class="temple-distance">
                                        Actual Road Detour: <strong>${temple.detour.toFixed(1)} km</strong>
                                    </div>
                                    <a href="${temple.link}" target="_blank" class="btn-navigate">Get Directions</a>
                                </div>
                            `).join('')}
                        `;
                    } else {
                        results.innerHTML = '<div class="temple-card">No temples found within the specified detour distance. Try increasing the detour range.</div>';
                    }
                } catch (error) {
                    loading.style.display = 'none';
                    error.style.display = 'block';
                    error.textContent = 'Error calculating route distances. Please try again.';
                    console.error('Route planning error:', error);
                }
            })();
        };

        // Find temples along route with real road distances
        async function findTemplesAlongRoute(start, end, maxDetour) {
            const templesWithDetour = [];
            const batchSize = 2; // Very small batches for route planning (3 API calls per temple)
            
            for (let i = 0; i < divyaDesams.length; i += batchSize) {
                const batch = divyaDesams.slice(i, i + batchSize);
                const batchPromises = batch.map(async temple => ({
                    ...temple,
                    detour: await calculateDetour(start, end, temple)
                }));
                
                const batchResults = await Promise.all(batchPromises);
                templesWithDetour.push(...batchResults);
                
                // Longer delay to avoid rate limiting (route planning uses more API calls)
                if (i + batchSize < divyaDesams.length) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            return templesWithDetour
                .filter(temple => temple.detour <= maxDetour)
                .sort((a, b) => a.detour - b.detour)
                .slice(0, 15);
        }

        // Calculate detour distance with improved algorithm using real road distances
        async function calculateDetour(start, end, temple) {
            const directRoadDistance = await calculateRoadDistance(start.lat, start.lng, end.lat, end.lng);
            
            // If start and end are very close (same city), use road distance from start point
            if (directRoadDistance < 2) {
                return await calculateRoadDistance(start.lat, start.lng, temple.lat, temple.lng);
            }
            
            const [startToTemple, templeToEnd] = await Promise.all([
                calculateRoadDistance(start.lat, start.lng, temple.lat, temple.lng),
                calculateRoadDistance(temple.lat, temple.lng, end.lat, end.lng)
            ]);
            
            const viaTempleRoadDistance = startToTemple + templeToEnd;
            return Math.max(0, viaTempleRoadDistance - directRoadDistance);
        }

        // OpenRoute Service API configuration
        const OPENROUTE_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6Ijg5OTQ4ZjIyNjdhNjRjMzM5ZjQzZGQ4ODViYjA1NDIwIiwiaCI6Im11cm11cjY0In0=';
        const OPENROUTE_BASE_URL = 'https://api.openrouteservice.org/v2';
        
        // Check if we can make direct API calls (GitHub Pages and most hosting supports this)
        const CAN_USE_API = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
        
        // Cache for storing route distances to avoid repeated API calls
        const routeCache = new Map();
        
        // Rate limiting variables
        let apiCallCount = 0;
        let lastResetTime = Date.now();
        const MAX_API_CALLS_PER_MINUTE = 40; // Conservative limit
        const RATE_LIMIT_WINDOW = 60000; // 1 minute
        
        // Generate cache key for route
        function getCacheKey(lat1, lon1, lat2, lon2) {
            return `${lat1.toFixed(4)},${lon1.toFixed(4)}-${lat2.toFixed(4)},${lon2.toFixed(4)}`;
        }
        
        // Check if we can make an API call (rate limiting)
        function canMakeApiCall() {
            const now = Date.now();
            
            // Reset counter if window has passed
            if (now - lastResetTime > RATE_LIMIT_WINDOW) {
                apiCallCount = 0;
                lastResetTime = now;
            }
            
            return apiCallCount < MAX_API_CALLS_PER_MINUTE;
        }
        
        // Get actual road distance using OpenRoute Service API
        async function getRealRoadDistance(lat1, lon1, lat2, lon2) {
            const cacheKey = getCacheKey(lat1, lon1, lat2, lon2);
            
            // Check cache first
            if (routeCache.has(cacheKey)) {
                return routeCache.get(cacheKey);
            }
            
            // Check reverse route in cache
            const reverseCacheKey = getCacheKey(lat2, lon2, lat1, lon1);
            if (routeCache.has(reverseCacheKey)) {
                const distance = routeCache.get(reverseCacheKey);
                routeCache.set(cacheKey, distance);
                return distance;
            }
            
            // For file:// protocol, use estimated distances (GitHub Pages will work fine)
            if (!CAN_USE_API) {
                return calculateEstimatedRoadDistance(lat1, lon1, lat2, lon2);
            }
            
            // Check rate limiting
            if (!canMakeApiCall()) {
                console.warn('Rate limit reached, falling back to estimated distance');
                return calculateEstimatedRoadDistance(lat1, lon1, lat2, lon2);
            }
            
            try {
                // Increment API call counter
                apiCallCount++;
                
                const url = `${OPENROUTE_BASE_URL}/directions/driving-car?api_key=${OPENROUTE_API_KEY}&start=${lon1},${lat1}&end=${lon2},${lat2}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    if (response.status === 429) {
                        console.warn('API rate limit exceeded, falling back to estimated distance');
                        return calculateEstimatedRoadDistance(lat1, lon1, lat2, lon2);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.features && data.features[0] && data.features[0].properties) {
                    const distanceMeters = data.features[0].properties.segments[0].distance;
                    const distanceKm = distanceMeters / 1000;
                    
                    // Cache the result
                    routeCache.set(cacheKey, distanceKm);
                    return distanceKm;
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.warn('OpenRoute API failed, falling back to estimated distance:', error);
                // Fallback to estimated road distance
                return calculateEstimatedRoadDistance(lat1, lon1, lat2, lon2);
            }
        }
        
        // Enhanced estimated road-distance calculation for India
        function calculateEstimatedRoadDistance(lat1, lon1, lat2, lon2) {
            const straightDistance = calculateDistance(lat1, lon1, lat2, lon2);
            
            // More sophisticated road factor calculation for Indian road conditions
            let roadFactor = 1.4; // Base factor
            
            // Distance-based adjustments (longer = better roads)
            if (straightDistance > 500) roadFactor = 1.2; // Long distance highways (NH)
            else if (straightDistance > 200) roadFactor = 1.3; // Medium highways (NH, SH)
            else if (straightDistance > 100) roadFactor = 1.4; // State highways
            else if (straightDistance > 50) roadFactor = 1.5; // District roads
            else if (straightDistance > 20) roadFactor = 1.6; // City outskirts
            else roadFactor = 1.8; // Urban/congested areas
            
            // Regional adjustments for terrain
            const avgLat = (lat1 + lat2) / 2;
            const avgLon = (lon1 + lon2) / 2;
            
            // Himalayan regions (mountain roads)
            if (avgLat > 30) roadFactor *= 1.2;
            
            // Western Ghats (South India hills)
            if (avgLat < 20 && avgLon < 77) roadFactor *= 1.1;
            
            // Major urban areas (traffic congestion)
            const isUrbanArea = (
                (avgLat > 28.5 && avgLat < 28.7 && avgLon > 77.1 && avgLon < 77.3) || // Delhi NCR
                (avgLat > 12.8 && avgLat < 13.2 && avgLon > 80.1 && avgLon < 80.3) || // Chennai
                (avgLat > 18.8 && avgLat < 19.3 && avgLon > 72.7 && avgLon < 73.0) || // Mumbai
                (avgLat > 12.8 && avgLat < 13.1 && avgLon > 77.5 && avgLon < 77.7)    // Bangalore
            );
            if (isUrbanArea && straightDistance < 30) roadFactor *= 1.2;
            
            return straightDistance * roadFactor;
        }
        
        // Main function to get road distance (tries API first, falls back to estimation)
        async function calculateRoadDistance(lat1, lon1, lat2, lon2) {
            return await getRealRoadDistance(lat1, lon1, lat2, lon2);
        }

        // Update detour slider value
        document.addEventListener('DOMContentLoaded', function() {
            const detourRange = document.getElementById('detourRange');
            const detourValue = document.getElementById('detourValue');
            
            detourRange.addEventListener('input', function() {
                detourValue.textContent = this.value;
            });
            
            // Initialize map and autocomplete
            initMap();
            setupAutocomplete();
        });
    </script>
</body>
</html>